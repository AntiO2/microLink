# Content Management Microservice (microlink-content)

This module handles content publishing, storage (S3), and review workflow (Activiti).

## 1. Prerequisites & Installation

### Prerequisites
*   **Java 21**
*   **Maven**
*   **Docker** (for MySQL)

### Setup Database
Start a MySQL container using the project's compose file or manually:
```bash
# In project root
docker compose up -d mysql
```
Ensure the database `mydatabase` exists.

### Configuration
Update `src/main/resources/application.properties` with your AWS keys and S3 path if needed:
```properties
aws.s3.accessKey=YOUR_ACCESS_KEY
aws.s3.secretKey=YOUR_SECRET_KEY
aws.s3.region=us-east-1
# Configure the full S3 path (Bucket + Prefix)
aws.s3.path=s3://home-dongyang/microlink/
```

### Build & Run
```bash
cd microlink-content
mvn clean install
mvn spring-boot:run
```
The service will start on port **8082**.

## 2. Integration Details

### Spring Cloud / REST API
The service follows RESTful standards. All endpoints are prefixed with `/api/content`.
*   **Publish**: `/api/content/publish`
*   **List**: `/api/content/list`
*   **Review**: `/api/content/review/*`

### Activiti Workflow
We use **Activiti 7** to manage the content review process.
*   **Definition**: `src/main/resources/processes/content-review.bpmn20.xml`
*   **Logic**:
    1.  User publishes content -> Status: `PENDING`
    2.  Process starts -> Task assigned to `admin` group
    3.  Admin reviews -> Status updates to `PUBLISHED` or `REJECTED`

### S3 Storage
Files are stored in AWS S3 using the configured `aws.s3.path`.
*   The system parses the URI (e.g., `s3://bucket/folder/`) to determine the bucket and directory.
*   Files are named with a UUID prefix to prevent collisions.

## 3. Step-by-Step Verification Guide

Follow these steps to verify functionalities. Note that you need a valid JWT token, which is generated by the **User Service** (`microlink-user`).

### Step 0: Obtain Token (User Service)
Ensure `microlink-user` is running on port **8081**.
1.  **Register/Login** to get the token.
    ```bash
    curl -X POST http://localhost:8081/api/user/auth/login \
      -H "Content-Type: application/json" \
      -d '{"username": "testuser", "password": "password"}'
    ```
    *(If the user doesn't exist, use `/register` first)*

2.  **Copy the `accessToken`** from the response. You will use this as `<YOUR_TOKEN>` or `<ADMIN_TOKEN>` (if the user has admin role).

### Step 1: Publish Content (User)

Here are examples for different content types (`POST`, `ARTICLE`, `VIDEO`).

**1. Publish a Post (Short Content)**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -F "text=Just a quick update!" \
  -F "contentType=POST" \
  -F "media=@/path/to/image.jpg"
```

**2. Publish an Article**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -F "title=My First Article" \
  -F "text=This is the detailed content of the article." \
  -F "contentType=ARTICLE" \
  -F "cover=@/path/to/cover.jpg"
```

**3. Publish a Video**
```bash
curl -X POST http://localhost:8082/api/content/publish \
  -H "Authorization: Bearer <YOUR_TOKEN>" \
  -F "title=My Vlog" \
  -F "text=Check out this video!" \
  -F "contentType=VIDEO" \
  -F "cover=@/path/to/thumbnail.jpg" \
  -F "media=@/path/to/video.mp4"
```

*Expected Output*: Content object with `status: "PENDING"`.

### Step 2: List Content
```bash
curl -X GET http://localhost:8082/api/content/list \
  -H "Authorization: Bearer <YOUR_TOKEN>"
```
*Expected Output*: List of content items.
*   **For General Users**: Returns only `PUBLISHED` content.
*   **For Author**: Returns `PUBLISHED` content PLUS any content (e.g., `PENDING`) authored by the current user.

### Step 3: Review Content (Admin)

**1. Get Review Tasks**
```bash
curl -X GET http://localhost:8082/api/content/review/tasks \
  -H "Authorization: Bearer <ADMIN_TOKEN>"
```
*Expected Output*: List of tasks (e.g., "Review Content"). **Copy the Task ID.**

**2. Approve Content**
```bash
curl -X POST http://localhost:8082/api/content/review/tasks/<TASK_ID> \
  -H "Authorization: Bearer <ADMIN_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"approved": true}'
```
*Expected Output*: `{"message":"Review completed"}`. Content status should now be `PUBLISHED`.

## 4. Running Tests
To verify the code integrity:
```bash
mvn test
```
